{% extends "ApachecmsFrontendBundle::layout_lp.html.twig" %}
{% block stylesheet %} 
{{ parent() }}
<link rel="stylesheet" href="{{ asset('bundles/apachecmsbackend/leaflet/leaflet.css') }}">
{% endblock %}
{% block body %}
{% set entity = query.landing %}
{{ include('ApachecmsFrontendBundle::_partials/brand.html.twig') }}
{% block headerPage %}
{% include 'ApachecmsFrontendBundle:_partials:breadcrumbs.html.twig' with { 'title_entity': entity.title } %}
{% endblock %}
<div class="container">
    <div class="row">
        <div class="col-md-3">
            {{ include('ApachecmsFrontendBundle::Stats/_partials/menu.html.twig') }}
        </div>
        <div class="col-md-9">
            <div class="card">
                <h2 class="card-header">
                    {{ 'queries' | trans }}
                </h2>
                <div class="card-body">
                    <div class="row">
                        <div class="form-group col-lg-6">
                            <label>{{ 'name' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.contact.name }}">
                        </div>
                        <div class="form-group col-lg-6">
                            <label>{{ 'email' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.contact.email }}">
                        </div>
                        <div class="form-group col-lg-6">
                            <label>{{ 'phone' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.contact.phone }}">
                        </div>
                        <div class="form-group col-lg-6">
                            <label>{{ 'sending.at' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.createdAt | date('Y/m/d H:i') }}">
                        </div>
                        {% if query.stats %}
                        <div class="form-group col-lg-12">
                            <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#exampleModal">
                                {{ 'view.more' | trans }}
                            </button>
                        </div>
                        {% endif %}
                        <div class="form-group col-lg-12">
                            <label>{{ 'query' | trans}}</label>
                            <textarea readonly="readonly" class="form-control" style="height:150px;">{{ query.query }}</textarea>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="card-header">
                            {{ 'answers' | trans }}
                        </h2>
                        <div class="card-body">
                            {% for reply in query.answers %}
                                <blockquote class="blockquote">
                                    <p class="mb-0">{{ 'sending' | trans }} {{ reply.createdAt | date('d/m/Y H:i') }}</p>
                                    <footer class="blockquote-footer">{{ reply.reply | nl2br }}</footer>
                                </blockquote> 
                                <hr>
                            {% endfor %}
                            {{ form_start(form, {'attr': {'class': 'sendToApi','id':'registerForm','novalidate':'novalidate'} }) }}
                            <div class="row">
                               <div class="form-group col-lg-12">
                                    {{form_label(form.reply)}} {{form_widget(form.reply)}}
                                    <small class="form-text text-danger">{{ form_errors(form.reply)}}</small>
                                </div>
                            </div>
                            {{form_widget(form.submit,{ 'attr':{'secondary-label':'loading' | trans}})}}
                            {{ form_end(form) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
{% if query.stats %}
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">{{ 'view.more' | trans }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="form-group col-lg-6">
                            <label>{{ 'browser' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.stats.browser }}">
                        </div>
                        <div class="form-group col-lg-6">
                            <label>{{ 'system.operative' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.stats.os }}">
                        </div>
                        <div class="form-group col-lg-6">
                            <label>{{ 'is.mobile' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{% if query.stats.isMobile %}{{ 'mobile' | trans }}{% else %}{{ 'pc' | trans }}{% endif %}">
                        </div>
                        <div class="form-group col-lg-6">
                            <label>{{ 'language' | trans}}</label>
                            <input type="text" readonly="readonly" class="form-control" value="{{ query.stats.language }}">
                        </div>
                        {% if query.stats.lat and query.stats.lng %}
                        <div class="form-group col-lg-12">
                            <label>{{ 'location' | trans}}</label>
                            <div id="map" style="height:400px;"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ 'close' | trans }}</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
{% block javascripts %} 
{{ parent() }}
<script>
    function beforeSuccess(response){
        location.reload();
    }
</script>
{% if query.stats and query.stats.lat and query.stats.lng %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.3/leaflet.js"></script>
<script>
    $('#exampleModal').on('show.bs.modal', function (e) {
        setTimeout(function(){ 
            var map = L.map('map').setView([{{ query.stats.lat }}, {{ query.stats.lng }}],11);
        L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 24,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiaW5hbWlrYSIsImEiOiJjams5c2x2dmEwZXFpM2x0NGxrOHAxc2FsIn0.CMTOZk_UmJQVRlqr7lxWRA'
            }).addTo(map);
        var marker = L.marker([{{ query.stats.lat }}, {{ query.stats.lng }}]).addTo(map);
        }, 500);
    })
</script>
{% endif %}
{% endblock %}